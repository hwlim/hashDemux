---
title: "clustering-based sample demultiplexing"
output:
  html_document:
    toc: true
    theme: united
    df_print: kable
date: 'Compiled: `r Sys.Date()`'
---

This vignette will provide an brief introduction on how to run a
newly-developed Seurat-based workflow for de-multiplexing of scRNA-seq
samples. This workflow takes as input tag counts matrix with tags as
rows and cell IDs as columns and return sample-of-origin for each cell. This workflow is detailed as follows: 

1. Sequencing depth normalization using centered-log ratio (CLR) transformation
2. uses graph clustering algorithm implemented using Seurat's
[`FindClusters`](https://satijalab.org/seurat/reference/findclusters)
function to group cells with similar tags profiles. 
3. for each cluster marker tags are identified using Seurat's
[`FindAllMarkers`](https://satijalab.org/seurat/reference/findallmarkers)
function. 
4. Cell assignment criteria 
    - If a cluster have at least two markers, cells belong to this cluster are classified as doublets 
    - If a cluster has only one marker, cells belong to this cluster are classified
as singlets. 
    - If a cluster has no marker, cells belong to this cluster are classified as negatives.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 95),
  message = FALSE,
  warning = FALSE
)
```

## Load necessary packages

```{r, message=FALSE}
library(Seurat)
library(doParallel)
library(hashDemux)
library(dplyr)
```

## Download and load data

```{r}

download.file("https://raw.githubusercontent.com/Oshlack/hashtag-demux-paper/main/data/BAL_data/batch1_c1_donors.csv", "ground_truth.csv")

download.file("https://raw.githubusercontent.com/Oshlack/hashtag-demux-paper/main/data/BAL_data/batch1_c1_hto_counts.csv", "hto_counts.csv")

# tags IDs and their corresponding donor IDs
# https://github.com/Oshlack/hashtag-demux-paper/blob/main/analysis/BAL_analysis.Rmd
HTO_donor_list_batch1 <- list("BAL 01" = "BAL A", 
                              "BAL 02" = "BAL B", 
                              "BAL 03" = "BAL C", 
                              "BAL 04" = "BAL D", 
                              "BAL 05" = "BAL E", 
                              "BAL 06" = "BAL F", 
                              "BAL 07" = "BAL G", 
                              "BAL 08" = "BAL H", 
                              "Doublet" = "Doublet", 
                              "Negative" = "Negative")

ground_truth = read.csv("ground_truth.csv", header = T,row.names = 1)
rownames(ground_truth) = ground_truth$Barcode
table(ground_truth$genetic_donor)

hto_counts = read.csv("hto_counts.csv", header = T, row.names = 1)
rownames(hto_counts) = HTO_donor_list_batch1[rownames(hto_counts)]

```

## create Seurat object

```{r}
seurat_object = CreateSeuratObject(counts = hto_counts,assay = "HTO", names.delim = "")
seurat_object

seurat_object$ground_truth = ground_truth$genetic_donor

seurat_object <- seurat_object[, sample(colnames(seurat_object), size = ncol(seurat_object), replace=F)]

```

## generate UMAP plot

```{r, message=FALSE,  fig.dim = c(15, 8)}
assay = "HTO"
seurat_object = seurat_object %>% NormalizeData(assay = assay, normalization.method = "CLR",margin = 2) %>% ScaleData()  
seurat_object = seurat_object %>% RunPCA(features = rownames(seurat_object@assays[[assay]]),npcs=nrow(seurat_object@assays[[assay]]) - 1)
seurat_object = seurat_object %>%  RunUMAP(dims = 1:(nrow(seurat_object@assays[[assay]]) - 1), seed.use = 1)

FeaturePlot(seurat_object, features = rownames(seurat_object), max.cutoff = "q95", min.cutoff = "q5", ncol = 4)

DimPlot(seurat_object, group.by = "ground_truth")
```

## clustering-based demultiplexing

```{r, message=FALSE, fig.dim = c(10, 7)}
seurat_object = clustering_based_demux(seurat_object, assay = "HTO")

#table(seurat_object$classification)
seurat_object$predicted.label = seurat_object$sampleBC
seurat_object$predicted.label[seurat_object$classification == "Doublet"] = "Doublet"


DimPlot(seurat_object,group.by = "classification") 
DimPlot(seurat_object,group.by = "predicted.label", label = T) 

DimPlot(seurat_object,group.by = "predicted.label", label = T) + DimPlot(seurat_object,group.by = "ground_truth", label = T)

```

### QC plots
```{r, fig.dim = c(12, 8)}
# find cell IDs of cells predicted to be comping from donors "BAL E" and "BAL F"
cells = colnames(seurat_object)[seurat_object$sampleBC == "BAL E_BAL F"]

# plot expression profile of "BAL E" and "BAL F" tags
FeaturePlot(seurat_object, features = c("BAL E", "BAL F"), max.cutoff = "q95", min.cutoff = "q5", ncol = 3)+  DimPlot(seurat_object,cells.highlight =  cells, label = F)&NoLegend()


norm_counts = seurat_object@assays$HTO$data %>% as.matrix() %>% t() %>% as.data.frame() 
topHTO_norm <- apply(norm_counts, 1, function(x) max(x))
secondHTO_norm <- apply(norm_counts, 1, function(x) max(x[x != max(x)] ))

seurat_object$ratio = topHTO_norm / secondHTO_norm

FeaturePlot(seurat_object, features = c("confidence_score","ratio","nCount_HTO"), max.cutoff = "q95", min.cutoff = "q5", ncol = 2)
seurat_object$concordance = seurat_object$predicted.label == seurat_object$ground_truth
DimPlot(seurat_object, group.by = "concordance")
```
